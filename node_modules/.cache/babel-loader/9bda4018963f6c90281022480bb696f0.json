{"ast":null,"code":"import _slicedToArray from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _regeneratorRuntime from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _classCallCheck from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import assert from'assert';import{useEffect,useReducer}from'react';import tuple from'immutable-tuple';var pageLoadTime=new Date();var globalCache=new Map();var errorCache=new Map();var FetchLoops=/*#__PURE__*/function(){function FetchLoops(){_classCallCheck(this,FetchLoops);this.loops=new Map();}_createClass(FetchLoops,[{key:\"addListener\",value:function addListener(listener){if(!this.loops.has(listener.cacheKey)){this.loops.set(listener.cacheKey,new FetchLoopInternal(listener.cacheKey,listener.fn));}this.loops.get(listener.cacheKey).addListener(listener);}},{key:\"removeListener\",value:function removeListener(listener){var loop=this.loops.get(listener.cacheKey);loop.removeListener(listener);if(loop.stopped){this.loops.delete(listener.cacheKey);}}},{key:\"refresh\",value:function refresh(cacheKey){if(this.loops.has(cacheKey)){this.loops.get(cacheKey).refresh();}}},{key:\"refreshAll\",value:function refreshAll(){return Promise.all(_toConsumableArray(this.loops.values()).map(function(loop){return loop.refresh();}));}}]);return FetchLoops;}();var globalLoops=new FetchLoops();var FetchLoopListener=function FetchLoopListener(cacheKey,fn,refreshInterval,callback){_classCallCheck(this,FetchLoopListener);this.cacheKey=void 0;this.fn=void 0;this.refreshInterval=void 0;this.callback=void 0;this.cacheKey=cacheKey;this.fn=fn;this.refreshInterval=refreshInterval;this.callback=callback;};var FetchLoopInternal=/*#__PURE__*/function(){function FetchLoopInternal(cacheKey,fn){var _this=this;_classCallCheck(this,FetchLoopInternal);this.cacheKey=void 0;this.fn=void 0;this.timeoutId=void 0;this.listeners=void 0;this.errors=void 0;this.refresh=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var data,waitTime,timeSincePageLoad;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(_this.timeoutId){clearTimeout(_this.timeoutId);_this.timeoutId=null;}if(!_this.stopped){_context.next=3;break;}return _context.abrupt(\"return\");case 3:_context.prev=3;_context.next=6;return _this.fn();case 6:data=_context.sent;globalCache.set(_this.cacheKey,data);errorCache.delete(_this.cacheKey);_this.errors=0;return _context.abrupt(\"return\",data);case 13:_context.prev=13;_context.t0=_context[\"catch\"](3);++_this.errors;globalCache.delete(_this.cacheKey);errorCache.set(_this.cacheKey,_context.t0);console.warn(_context.t0);case 19:_context.prev=19;_this.notifyListeners();if(!_this.timeoutId&&!_this.stopped){waitTime=_this.refreshInterval;// Back off on errors.\nif(_this.errors>0){waitTime=Math.min(1000*Math.pow(2,_this.errors-1),60000);}// Don't do any refreshing for the first five seconds, to make way for other things to load.\ntimeSincePageLoad=+new Date()-+pageLoadTime;if(timeSincePageLoad<5000){waitTime+=5000-timeSincePageLoad/2;}// Refresh background pages slowly.\nif(document.visibilityState==='hidden'){waitTime=60000;}else if(!document.hasFocus()){waitTime*=1.5;}// Add jitter so we don't send all requests at the same time.\nwaitTime*=0.8+0.4*Math.random();_this.timeoutId=setTimeout(_this.refresh,waitTime);}return _context.finish(19);case 23:case\"end\":return _context.stop();}}},_callee,null,[[3,13,19,23]]);}));this.cacheKey=cacheKey;this.fn=fn;this.timeoutId=null;this.listeners=new Set();this.errors=0;}_createClass(FetchLoopInternal,[{key:\"addListener\",value:function addListener(listener){var previousRefreshInterval=this.refreshInterval;this.listeners.add(listener);if(this.refreshInterval<previousRefreshInterval){this.refresh();}}},{key:\"removeListener\",value:function removeListener(listener){assert(this.listeners.delete(listener));if(this.stopped){if(this.timeoutId){clearTimeout(this.timeoutId);this.timeoutId=null;}}}},{key:\"notifyListeners\",value:function notifyListeners(){this.listeners.forEach(function(listener){return listener.callback();});}},{key:\"refreshInterval\",get:function get(){return Math.min.apply(Math,_toConsumableArray(_toConsumableArray(this.listeners).map(function(listener){return listener.refreshInterval;})));}},{key:\"stopped\",get:function get(){return this.listeners.size===0;}}]);return FetchLoopInternal;}();// returns [data, loaded, error]\n// loaded is false when error is present for backwards compatibility\nexport function useAsyncData(asyncFn,cacheKey){var _ref2=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},_ref2$refreshInterval=_ref2.refreshInterval,refreshInterval=_ref2$refreshInterval===void 0?60000:_ref2$refreshInterval;var _useReducer=useReducer(function(i){return i+1;},0),_useReducer2=_slicedToArray(_useReducer,2),rerender=_useReducer2[1];cacheKey=formatCacheKey(cacheKey);useEffect(function(){if(!cacheKey){return;}var listener=new FetchLoopListener(cacheKey,asyncFn,refreshInterval,rerender);globalLoops.addListener(listener);return function(){return globalLoops.removeListener(listener);};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[cacheKey,refreshInterval]);if(!cacheKey){return[null,false,undefined];}var loaded=globalCache.has(cacheKey);var error=errorCache.has(cacheKey)?errorCache.get(cacheKey):undefined;var data=loaded?globalCache.get(cacheKey):undefined;return[data,loaded,error];}export function refreshCache(cacheKey){var clearCache=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;cacheKey=formatCacheKey(cacheKey);if(clearCache){globalCache.delete(cacheKey);}var loop=globalLoops.loops.get(cacheKey);if(loop){loop.refresh();if(clearCache){loop.notifyListeners();}}}export function setCache(cacheKey,value){var _ref3=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},_ref3$initializeOnly=_ref3.initializeOnly,initializeOnly=_ref3$initializeOnly===void 0?false:_ref3$initializeOnly;cacheKey=formatCacheKey(cacheKey);if(initializeOnly&&globalCache.has(cacheKey)){return;}globalCache.set(cacheKey,value);var loop=globalLoops.loops.get(cacheKey);if(loop){loop.notifyListeners();}}function formatCacheKey(cacheKey){if(Array.isArray(cacheKey)){return tuple.apply(void 0,_toConsumableArray(cacheKey));}return cacheKey;}","map":{"version":3,"sources":["/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/src/utils/fetch-loop.ts"],"names":["assert","useEffect","useReducer","tuple","pageLoadTime","Date","globalCache","Map","errorCache","FetchLoops","loops","listener","has","cacheKey","set","FetchLoopInternal","fn","get","addListener","loop","removeListener","stopped","delete","refresh","Promise","all","values","map","globalLoops","FetchLoopListener","refreshInterval","callback","timeoutId","listeners","errors","clearTimeout","data","console","warn","notifyListeners","waitTime","Math","min","timeSincePageLoad","document","visibilityState","hasFocus","random","setTimeout","Set","previousRefreshInterval","add","forEach","size","useAsyncData","asyncFn","i","rerender","formatCacheKey","undefined","loaded","error","refreshCache","clearCache","setCache","value","initializeOnly","Array","isArray"],"mappings":"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","sourcesContent":["import assert from 'assert';\nimport { useEffect, useReducer } from 'react';\nimport tuple from 'immutable-tuple';\n\nconst pageLoadTime = new Date();\n\nconst globalCache: Map<any, any> = new Map();\nconst errorCache: Map<any, any> = new Map();\n\nclass FetchLoops {\n  loops = new Map();\n\n  addListener(listener) {\n    if (!this.loops.has(listener.cacheKey)) {\n      this.loops.set(\n        listener.cacheKey,\n        new FetchLoopInternal(listener.cacheKey, listener.fn),\n      );\n    }\n    this.loops.get(listener.cacheKey).addListener(listener);\n  }\n\n  removeListener(listener) {\n    let loop = this.loops.get(listener.cacheKey);\n    loop.removeListener(listener);\n    if (loop.stopped) {\n      this.loops.delete(listener.cacheKey);\n    }\n  }\n\n  refresh(cacheKey) {\n    if (this.loops.has(cacheKey)) {\n      this.loops.get(cacheKey).refresh();\n    }\n  }\n\n  refreshAll() {\n    return Promise.all([...this.loops.values()].map((loop) => loop.refresh()));\n  }\n}\nconst globalLoops = new FetchLoops();\n\nclass FetchLoopListener<T = any> {\n  cacheKey: any;\n  fn: () => Promise<T>;\n  refreshInterval: number;\n  callback: () => void;\n\n  constructor(\n    cacheKey: any,\n    fn: () => Promise<T>,\n    refreshInterval: number,\n    callback: () => void,\n  ) {\n    this.cacheKey = cacheKey;\n    this.fn = fn;\n    this.refreshInterval = refreshInterval;\n    this.callback = callback;\n  }\n}\n\nclass FetchLoopInternal<T = any> {\n  cacheKey: any;\n  fn: () => Promise<T>;\n  timeoutId: null | any;\n  listeners: Set<FetchLoopListener<T>>;\n  errors: number;\n\n  constructor(cacheKey: any, fn: () => Promise<T>) {\n    this.cacheKey = cacheKey;\n    this.fn = fn;\n    this.timeoutId = null;\n    this.listeners = new Set();\n    this.errors = 0;\n  }\n\n  get refreshInterval(): number {\n    return Math.min(\n      ...[...this.listeners].map((listener) => listener.refreshInterval),\n    );\n  }\n\n  get stopped(): boolean {\n    return this.listeners.size === 0;\n  }\n\n  addListener(listener: FetchLoopListener<T>): void {\n    const previousRefreshInterval = this.refreshInterval;\n    this.listeners.add(listener);\n    if (this.refreshInterval < previousRefreshInterval) {\n      this.refresh();\n    }\n  }\n\n  removeListener(listener: FetchLoopListener<T>): void {\n    assert(this.listeners.delete(listener));\n    if (this.stopped) {\n      if (this.timeoutId) {\n        clearTimeout(this.timeoutId);\n        this.timeoutId = null;\n      }\n    }\n  }\n\n  notifyListeners(): void {\n    this.listeners.forEach((listener) => listener.callback());\n  }\n\n  refresh = async () => {\n    if (this.timeoutId) {\n      clearTimeout(this.timeoutId);\n      this.timeoutId = null;\n    }\n    if (this.stopped) {\n      return;\n    }\n\n    try {\n      const data = await this.fn();\n      globalCache.set(this.cacheKey, data);\n      errorCache.delete(this.cacheKey);\n      this.errors = 0;\n      return data;\n    } catch (error) {\n      ++this.errors;\n      globalCache.delete(this.cacheKey);\n      errorCache.set(this.cacheKey, error);\n      console.warn(error);\n    } finally {\n      this.notifyListeners();\n      if (!this.timeoutId && !this.stopped) {\n        let waitTime = this.refreshInterval;\n\n        // Back off on errors.\n        if (this.errors > 0) {\n          waitTime = Math.min(1000 * 2 ** (this.errors - 1), 60000);\n        }\n\n        // Don't do any refreshing for the first five seconds, to make way for other things to load.\n        const timeSincePageLoad = +new Date() - +pageLoadTime;\n        if (timeSincePageLoad < 5000) {\n          waitTime += 5000 - timeSincePageLoad / 2;\n        }\n\n        // Refresh background pages slowly.\n        if (document.visibilityState === 'hidden') {\n          waitTime = 60000;\n        } else if (!document.hasFocus()) {\n          waitTime *= 1.5;\n        }\n\n        // Add jitter so we don't send all requests at the same time.\n        waitTime *= 0.8 + 0.4 * Math.random();\n\n        this.timeoutId = setTimeout(this.refresh, waitTime);\n      }\n    }\n  };\n}\n\n// returns [data, loaded, error]\n// loaded is false when error is present for backwards compatibility\nexport function useAsyncData<T = any>(\n  asyncFn: () => Promise<T>,\n  cacheKey: any,\n  { refreshInterval = 60000 } = {},\n): [null | undefined | T, boolean, any] {\n  const [, rerender] = useReducer((i) => i + 1, 0);\n  cacheKey = formatCacheKey(cacheKey);\n\n  useEffect(() => {\n    if (!cacheKey) {\n      return;\n    }\n    const listener = new FetchLoopListener<T>(\n      cacheKey,\n      asyncFn,\n      refreshInterval,\n      rerender,\n    );\n    globalLoops.addListener(listener);\n    return () => globalLoops.removeListener(listener);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [cacheKey, refreshInterval]);\n\n  if (!cacheKey) {\n    return [null, false, undefined];\n  }\n\n  const loaded = globalCache.has(cacheKey);\n  const error = errorCache.has(cacheKey) ? errorCache.get(cacheKey) : undefined;\n  const data = loaded ? globalCache.get(cacheKey) : undefined;\n  return [data, loaded, error];\n}\n\nexport function refreshCache(cacheKey, clearCache = false) {\n  cacheKey = formatCacheKey(cacheKey);\n  if (clearCache) {\n    globalCache.delete(cacheKey);\n  }\n  const loop = globalLoops.loops.get(cacheKey);\n  if (loop) {\n    loop.refresh();\n    if (clearCache) {\n      loop.notifyListeners();\n    }\n  }\n}\n\nexport function setCache(cacheKey, value, { initializeOnly = false } = {}) {\n  cacheKey = formatCacheKey(cacheKey);\n  if (initializeOnly && globalCache.has(cacheKey)) {\n    return;\n  }\n  globalCache.set(cacheKey, value);\n  const loop = globalLoops.loops.get(cacheKey);\n  if (loop) {\n    loop.notifyListeners();\n  }\n}\n\nfunction formatCacheKey(cacheKey) {\n  if (Array.isArray(cacheKey)) {\n    return tuple(...cacheKey);\n  }\n  return cacheKey;\n}\n"]},"metadata":{},"sourceType":"module"}