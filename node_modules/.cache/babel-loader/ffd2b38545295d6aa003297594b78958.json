{"ast":null,"code":"import{jsxs as _jsxs}from\"react/jsx-runtime\";import _regeneratorRuntime from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _defineProperty from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import{jsx as _jsx}from\"react/jsx-runtime\";import _toConsumableArray from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useCallback,useEffect,useMemo,useRef,useState}from'react';import{useWallet,useWalletSelector}from'../utils/wallet';import{PublicKey}from'@solana/web3.js';import{Divider,FormControlLabel,SnackbarContent,Switch,Typography}from'@material-ui/core';import Card from'@material-ui/core/Card';import CardContent from'@material-ui/core/CardContent';import CardActions from'@material-ui/core/CardActions';import Button from'@material-ui/core/Button';import ImportExportIcon from'@material-ui/icons/ImportExport';import{makeStyles}from'@material-ui/core/styles';import assert from'assert';import bs58 from'bs58';import WarningIcon from'@material-ui/icons/Warning';import{useLocalStorageState,isExtension}from'../utils/utils';import SignTransactionFormContent from'../components/SignTransactionFormContent';import SignFormContent from'../components/SignFormContent';import{generateDiffieHelllman}from'../utils/diffie-hellman';var AUTHORIZED_METHODS=['signTransaction','signAllTransactions','sign','diffieHellman'];function getInitialRequests(){if(!isExtension){return[];}// TODO CHECK OPENER (?)\nvar urlParams=new URLSearchParams(window.location.hash.slice(1));var request=JSON.parse(urlParams.get('request'));if(request.method==='sign'){var dataObj=request.params.data;// Deserialize `data` into a Uint8Array\nif(!dataObj){throw new Error('Missing \"data\" params for \"sign\" request');}var data=new Uint8Array(Object.keys(dataObj).length);for(var _i=0,_Object$entries=Object.entries(dataObj);_i<_Object$entries.length;_i++){var _Object$entries$_i=_slicedToArray(_Object$entries[_i],2),index=_Object$entries$_i[0],value=_Object$entries$_i[1];data[index]=value;}request.params.data=data;}return[request];}export default function PopupPage(_ref){var opener=_ref.opener;var origin=useMemo(function(){var params=new URLSearchParams(window.location.hash.slice(1));return params.get('origin');},[]);var selectedWallet=useWallet();var selectedWalletAddress=selectedWallet&&selectedWallet.publicKey.toBase58();var _useWalletSelector=useWalletSelector(),accounts=_useWalletSelector.accounts,setWalletSelector=_useWalletSelector.setWalletSelector;var _useState=useState(isExtension?null:selectedWallet),_useState2=_slicedToArray(_useState,2),wallet=_useState2[0],setWallet=_useState2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),connectedAccount=_useState4[0],setConnectedAccount=_useState4[1];var hasConnectedAccount=!!connectedAccount;var _useState5=useState(getInitialRequests),_useState6=_slicedToArray(_useState5,2),requests=_useState6[0],setRequests=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),autoApprove=_useState8[0],setAutoApprove=_useState8[1];var postMessage=useCallback(function(message){if(isExtension){chrome.runtime.sendMessage({channel:'sollet_extension_background_channel',data:message});}else{opener.postMessage(_objectSpread({jsonrpc:'2.0'},message),origin);}},[opener,origin]);// Keep selectedWallet and wallet in sync.\nuseEffect(function(){if(!isExtension){setWallet(selectedWallet);}// using stronger condition here\n// eslint-disable-next-line react-hooks/exhaustive-deps\n},[selectedWalletAddress]);// (Extension only) Fetch connected wallet for site from local storage.\nuseEffect(function(){if(isExtension){chrome.storage.local.get('connectedWallets',function(result){var connectedWallet=(result.connectedWallets||{})[origin];if(connectedWallet){setWalletSelector(connectedWallet.selector);setConnectedAccount(new PublicKey(connectedWallet.publicKey));setAutoApprove(connectedWallet.autoApprove);}else{setConnectedAccount(selectedWallet.publicKey);}});}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[origin]);// (Extension only) Set wallet once connectedWallet is retrieved.\nuseEffect(function(){if(isExtension&&connectedAccount){setWallet(selectedWallet);}// using stronger condition here\n// eslint-disable-next-line react-hooks/exhaustive-deps\n},[connectedAccount,selectedWalletAddress]);// Send a disconnect event if this window is closed, this component is\n// unmounted, or setConnectedAccount(null) is called.\nuseEffect(function(){if(hasConnectedAccount&&!isExtension){var unloadHandler=function unloadHandler(){postMessage({method:'disconnected'});};window.addEventListener('beforeunload',unloadHandler);return function(){unloadHandler();window.removeEventListener('beforeunload',unloadHandler);};}},[hasConnectedAccount,postMessage,origin]);// Disconnect if the user switches to a different wallet.\nuseEffect(function(){if(!isExtension&&wallet&&connectedAccount&&!connectedAccount.equals(wallet.publicKey)){setConnectedAccount(null);}},[connectedAccount,wallet]);// Push requests from the parent window into a queue.\nuseEffect(function(){function messageHandler(e){if(e.origin===origin&&e.source===window.opener){if(!AUTHORIZED_METHODS.includes(e.data.method)){postMessage({error:'Unsupported method',id:e.data.id});}setRequests(function(requests){return[].concat(_toConsumableArray(requests),[e.data]);});}}window.addEventListener('message',messageHandler);return function(){return window.removeEventListener('message',messageHandler);};},[origin,postMessage]);var request=requests[0];var popRequest=function popRequest(){return setRequests(function(requests){return requests.slice(1);});};var _useMemo=useMemo(function(){if(!request||request.method==='connect'){return{messages:[],messageDisplay:'tx'};}switch(request.method){case'diffieHellman':return{messages:[request.params.publicKey],messageDisplay:'diffieHellman'};case'signTransaction':return{messages:[bs58.decode(request.params.message)],messageDisplay:'tx'};case'signAllTransactions':return{messages:request.params.messages.map(function(m){return bs58.decode(m);}),messageDisplay:'tx'};case'sign':if(!(request.params.data instanceof Uint8Array)){throw new Error('Data must be an instance of Uint8Array');}return{messages:[request.params.data],messageDisplay:request.params.display==='utf8'?'utf8':'hex'};default:throw new Error('Unexpected method: '+request.method);}},[request]),messages=_useMemo.messages,messageDisplay=_useMemo.messageDisplay;if(hasConnectedAccount&&requests.length===0){if(isExtension){window.close();}else{focusParent();}return/*#__PURE__*/_jsx(Typography,{children:isExtension?'Submitting...':'Please keep this window open in the background.'});}if(!wallet){return/*#__PURE__*/_jsx(Typography,{children:\"Loading wallet...\"});}var mustConnect=!connectedAccount||!connectedAccount.equals(wallet.publicKey);// We must detect when to show the connection form on the website as it is not sent as a request.\nif(isExtension&&request.method==='connect'||!isExtension&&mustConnect){// Approve the parent page to connect to this wallet.\nvar connect=function connect(autoApprove){setConnectedAccount(wallet.publicKey);if(isExtension){chrome.storage.local.get('connectedWallets',function(result){// TODO better way to do this\nvar account=accounts.find(function(account){return account.address.equals(wallet.publicKey);});var connectedWallets=_objectSpread(_objectSpread({},result.connectedWallets||{}),{},_defineProperty({},origin,{publicKey:wallet.publicKey.toBase58(),selector:account.selector,autoApprove:autoApprove}));chrome.storage.local.set({connectedWallets:connectedWallets});});}postMessage({method:'connected',params:{publicKey:wallet.publicKey.toBase58(),autoApprove:autoApprove},id:isExtension?request.id:undefined});setAutoApprove(autoApprove);if(!isExtension){focusParent();}else{popRequest();}};return/*#__PURE__*/_jsx(ApproveConnectionForm,{origin:origin,onApprove:connect});}assert(AUTHORIZED_METHODS.includes(request.method)&&wallet);function onApprove(){return _onApprove.apply(this,arguments);}function _onApprove(){_onApprove=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:popRequest();_context.t0=request.method;_context.next=_context.t0==='diffieHellman'?4:_context.t0==='signTransaction'?5:_context.t0==='sign'?5:_context.t0==='signAllTransactions'?7:9;break;case 4:return _context.abrupt(\"return\",diffieHellman(messages[0]));case 5:sendSignature(messages[0]);return _context.abrupt(\"break\",10);case 7:sendAllSignatures(messages);return _context.abrupt(\"break\",10);case 9:throw new Error('Unexpected method: '+request.method);case 10:case\"end\":return _context.stop();}}},_callee);}));return _onApprove.apply(this,arguments);}function sendSignature(_x){return _sendSignature.apply(this,arguments);}function _sendSignature(){_sendSignature=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(message){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.t0=postMessage;_context2.next=3;return wallet.createSignature(message);case 3:_context2.t1=_context2.sent;_context2.t2=wallet.publicKey.toBase58();_context2.t3={signature:_context2.t1,publicKey:_context2.t2};_context2.t4=request.id;_context2.t5={result:_context2.t3,id:_context2.t4};(0,_context2.t0)(_context2.t5);case 9:case\"end\":return _context2.stop();}}},_callee2);}));return _sendSignature.apply(this,arguments);}function sendAllSignatures(_x2){return _sendAllSignatures.apply(this,arguments);}function _sendAllSignatures(){_sendAllSignatures=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(messages){var signatures,k;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!(wallet.type==='ledger')){_context3.next=14;break;}signatures=[];k=0;case 3:if(!(k<messages.length)){_context3.next=12;break;}_context3.t0=signatures;_context3.next=7;return wallet.createSignature(messages[k]);case 7:_context3.t1=_context3.sent;_context3.t0.push.call(_context3.t0,_context3.t1);case 9:k+=1;_context3.next=3;break;case 12:_context3.next=17;break;case 14:_context3.next=16;return Promise.all(messages.map(function(m){return wallet.createSignature(m);}));case 16:signatures=_context3.sent;case 17:postMessage({result:{signatures:signatures,publicKey:wallet.publicKey.toBase58()},id:request.id});case 18:case\"end\":return _context3.stop();}}},_callee3);}));return _sendAllSignatures.apply(this,arguments);}function diffieHellman(publicKey){var keys=generateDiffieHelllman(publicKey,wallet.provider.account.secretKey);postMessage({result:keys,id:request.id});}function sendReject(){popRequest();postMessage({error:'Transaction cancelled',id:request.id});}return/*#__PURE__*/_jsx(ApproveSignatureForm,{autoApprove:autoApprove,origin:origin,messages:messages,messageDisplay:messageDisplay,onApprove:onApprove,onReject:sendReject},request.id);}/**\n * Switch focus to the parent window. This requires that the parent runs\n * `window.name = 'parent'` before opening the popup.\n */function focusParent(){try{window.open('','parent');}catch(err){console.log('err',err);}}var useStyles=makeStyles(function(theme){return{connection:{marginTop:theme.spacing(3),marginBottom:theme.spacing(3),textAlign:'center'},transaction:{wordBreak:'break-all'},approveButton:{backgroundColor:'#43a047',color:'white'},actions:{justifyContent:'space-between'},snackbarRoot:{backgroundColor:theme.palette.background.paper},warningMessage:{margin:theme.spacing(1),color:theme.palette.text.primary},warningIcon:{marginRight:theme.spacing(1),fontSize:24},warningTitle:{color:theme.palette.warning.light,fontWeight:600,fontSize:16,alignItems:'center',display:'flex'},warningContainer:{marginTop:theme.spacing(1)},divider:{marginTop:theme.spacing(2),marginBottom:theme.spacing(2)}};});function ApproveConnectionForm(_ref2){var origin=_ref2.origin,onApprove=_ref2.onApprove;var wallet=useWallet();var _useWalletSelector2=useWalletSelector(),accounts=_useWalletSelector2.accounts,hardwareWalletAccount=_useWalletSelector2.hardwareWalletAccount;// TODO better way to do this\nvar account=accounts.concat([hardwareWalletAccount]).find(function(account){return account&&account.address.equals(wallet.publicKey);});var classes=useStyles();var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),autoApprove=_useState10[0],setAutoApprove=_useState10[1];var _useLocalStorageState=useLocalStorageState('dismissedAutoApproveWarning',false),_useLocalStorageState2=_slicedToArray(_useLocalStorageState,2),dismissed=_useLocalStorageState2[0],setDismissed=_useLocalStorageState2[1];return/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",component:\"h1\",gutterBottom:true,children:\"Allow this site to access your Solana account?\"}),/*#__PURE__*/_jsxs(\"div\",{className:classes.connection,children:[/*#__PURE__*/_jsx(Typography,{children:origin}),/*#__PURE__*/_jsx(ImportExportIcon,{fontSize:\"large\"}),/*#__PURE__*/_jsx(Typography,{children:account.name}),/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",children:[\"(\",wallet.publicKey.toBase58(),\")\"]})]}),/*#__PURE__*/_jsx(Typography,{children:\"Only connect with sites you trust.\"}),/*#__PURE__*/_jsx(Divider,{className:classes.divider}),/*#__PURE__*/_jsx(FormControlLabel,{control:/*#__PURE__*/_jsx(Switch,{checked:autoApprove,onChange:function onChange(){return setAutoApprove(!autoApprove);},color:\"primary\"}),label:\"Automatically approve transactions from \".concat(origin)}),!dismissed&&autoApprove&&/*#__PURE__*/_jsx(SnackbarContent,{className:classes.warningContainer,message:/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"span\",{className:classes.warningTitle,children:[/*#__PURE__*/_jsx(WarningIcon,{className:classes.warningIcon}),\"Use at your own risk.\"]}),/*#__PURE__*/_jsx(Typography,{className:classes.warningMessage,children:\"This setting allows sending some transactions on your behalf without requesting your permission for the remainder of this session.\"})]}),action:[/*#__PURE__*/_jsx(Button,{onClick:function onClick(){return setDismissed('1');},children:\"I understand\"})],classes:{root:classes.snackbarRoot}})]}),/*#__PURE__*/_jsxs(CardActions,{className:classes.actions,children:[/*#__PURE__*/_jsx(Button,{onClick:window.close,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{color:\"primary\",onClick:function onClick(){return onApprove(autoApprove);},disabled:!dismissed&&autoApprove,children:\"Connect\"})]})]});}function ApproveSignatureForm(_ref3){var origin=_ref3.origin,messages=_ref3.messages,messageDisplay=_ref3.messageDisplay,onApprove=_ref3.onApprove,onReject=_ref3.onReject,autoApprove=_ref3.autoApprove;var classes=useStyles();var buttonRef=useRef();var isMultiTx=messageDisplay==='tx'&&messages.length>1;var renderFormContent=function renderFormContent(){if(messageDisplay==='tx'){return/*#__PURE__*/_jsx(SignTransactionFormContent,{autoApprove:autoApprove,origin:origin,messages:messages,onApprove:onApprove,buttonRef:buttonRef});}else{return/*#__PURE__*/_jsx(SignFormContent,{origin:origin,message:messages[0],messageDisplay:messageDisplay,buttonRef:buttonRef});}};return/*#__PURE__*/_jsxs(Card,{children:[renderFormContent(),/*#__PURE__*/_jsxs(CardActions,{className:classes.actions,children:[/*#__PURE__*/_jsx(Button,{onClick:onReject,children:\"Cancel\"}),/*#__PURE__*/_jsxs(Button,{ref:buttonRef,className:classes.approveButton,variant:\"contained\",color:\"primary\",onClick:onApprove,children:[\"Approve\",isMultiTx?' All':'']})]})]});}","map":{"version":3,"sources":["/Users/jalcantara/Desktop/SOL-dev/tanda-wallet-sol/src/pages/PopupPage.js"],"names":["React","useCallback","useEffect","useMemo","useRef","useState","useWallet","useWalletSelector","PublicKey","Divider","FormControlLabel","SnackbarContent","Switch","Typography","Card","CardContent","CardActions","Button","ImportExportIcon","makeStyles","assert","bs58","WarningIcon","useLocalStorageState","isExtension","SignTransactionFormContent","SignFormContent","generateDiffieHelllman","AUTHORIZED_METHODS","getInitialRequests","urlParams","URLSearchParams","window","location","hash","slice","request","JSON","parse","get","method","dataObj","params","data","Error","Uint8Array","Object","keys","length","entries","index","value","PopupPage","opener","origin","selectedWallet","selectedWalletAddress","publicKey","toBase58","accounts","setWalletSelector","wallet","setWallet","connectedAccount","setConnectedAccount","hasConnectedAccount","requests","setRequests","autoApprove","setAutoApprove","postMessage","message","chrome","runtime","sendMessage","channel","jsonrpc","storage","local","result","connectedWallet","connectedWallets","selector","unloadHandler","addEventListener","removeEventListener","equals","messageHandler","e","source","includes","error","id","popRequest","messages","messageDisplay","decode","map","m","display","close","focusParent","mustConnect","connect","account","find","address","set","undefined","onApprove","diffieHellman","sendSignature","sendAllSignatures","createSignature","signature","type","signatures","k","push","Promise","all","provider","secretKey","sendReject","open","err","console","log","useStyles","theme","connection","marginTop","spacing","marginBottom","textAlign","transaction","wordBreak","approveButton","backgroundColor","color","actions","justifyContent","snackbarRoot","palette","background","paper","warningMessage","margin","text","primary","warningIcon","marginRight","fontSize","warningTitle","warning","light","fontWeight","alignItems","warningContainer","divider","ApproveConnectionForm","hardwareWalletAccount","concat","classes","dismissed","setDismissed","name","root","ApproveSignatureForm","onReject","buttonRef","isMultiTx","renderFormContent"],"mappings":"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","sourcesContent":["import React, {\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from 'react';\nimport { useWallet, useWalletSelector } from '../utils/wallet';\nimport { PublicKey } from '@solana/web3.js';\nimport {\n  Divider,\n  FormControlLabel,\n  SnackbarContent,\n  Switch,\n  Typography,\n} from '@material-ui/core';\nimport Card from '@material-ui/core/Card';\nimport CardContent from '@material-ui/core/CardContent';\nimport CardActions from '@material-ui/core/CardActions';\nimport Button from '@material-ui/core/Button';\nimport ImportExportIcon from '@material-ui/icons/ImportExport';\nimport { makeStyles } from '@material-ui/core/styles';\nimport assert from 'assert';\nimport bs58 from 'bs58';\nimport WarningIcon from '@material-ui/icons/Warning';\nimport { useLocalStorageState, isExtension } from '../utils/utils';\nimport SignTransactionFormContent from '../components/SignTransactionFormContent';\nimport SignFormContent from '../components/SignFormContent';\nimport { generateDiffieHelllman } from '../utils/diffie-hellman';\n\nconst AUTHORIZED_METHODS = [\n  'signTransaction',\n  'signAllTransactions',\n  'sign',\n  'diffieHellman',\n];\n\nfunction getInitialRequests() {\n  if (!isExtension) {\n    return [];\n  }\n\n  // TODO CHECK OPENER (?)\n\n  const urlParams = new URLSearchParams(window.location.hash.slice(1));\n  const request = JSON.parse(urlParams.get('request'));\n\n  if (request.method === 'sign') {\n    const dataObj = request.params.data;\n    // Deserialize `data` into a Uint8Array\n    if (!dataObj) {\n      throw new Error('Missing \"data\" params for \"sign\" request');\n    }\n\n    const data = new Uint8Array(Object.keys(dataObj).length);\n    for (const [index, value] of Object.entries(dataObj)) {\n      data[index] = value;\n    }\n    request.params.data = data;\n  }\n\n  return [request];\n}\n\nexport default function PopupPage({ opener }) {\n  const origin = useMemo(() => {\n    let params = new URLSearchParams(window.location.hash.slice(1));\n    return params.get('origin');\n  }, []);\n  const selectedWallet = useWallet();\n  const selectedWalletAddress =\n    selectedWallet && selectedWallet.publicKey.toBase58();\n  const { accounts, setWalletSelector } = useWalletSelector();\n  const [wallet, setWallet] = useState(isExtension ? null : selectedWallet);\n\n  const [connectedAccount, setConnectedAccount] = useState(null);\n  const hasConnectedAccount = !!connectedAccount;\n  const [requests, setRequests] = useState(getInitialRequests);\n  const [autoApprove, setAutoApprove] = useState(false);\n  const postMessage = useCallback(\n    (message) => {\n      if (isExtension) {\n        chrome.runtime.sendMessage({\n          channel: 'sollet_extension_background_channel',\n          data: message,\n        });\n      } else {\n        opener.postMessage({ jsonrpc: '2.0', ...message }, origin);\n      }\n    },\n    [opener, origin],\n  );\n\n  // Keep selectedWallet and wallet in sync.\n  useEffect(() => {\n    if (!isExtension) {\n      setWallet(selectedWallet);\n    }\n    // using stronger condition here\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selectedWalletAddress]);\n\n  // (Extension only) Fetch connected wallet for site from local storage.\n  useEffect(() => {\n    if (isExtension) {\n      chrome.storage.local.get('connectedWallets', (result) => {\n        const connectedWallet = (result.connectedWallets || {})[origin];\n        if (connectedWallet) {\n          setWalletSelector(connectedWallet.selector);\n          setConnectedAccount(new PublicKey(connectedWallet.publicKey));\n          setAutoApprove(connectedWallet.autoApprove);\n        } else {\n          setConnectedAccount(selectedWallet.publicKey);\n        }\n      });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [origin]);\n\n  // (Extension only) Set wallet once connectedWallet is retrieved.\n  useEffect(() => {\n    if (isExtension && connectedAccount) {\n      setWallet(selectedWallet);\n    }\n    // using stronger condition here\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [connectedAccount, selectedWalletAddress]);\n\n  // Send a disconnect event if this window is closed, this component is\n  // unmounted, or setConnectedAccount(null) is called.\n  useEffect(() => {\n    if (hasConnectedAccount && !isExtension) {\n      function unloadHandler() {\n        postMessage({ method: 'disconnected' });\n      }\n      window.addEventListener('beforeunload', unloadHandler);\n      return () => {\n        unloadHandler();\n        window.removeEventListener('beforeunload', unloadHandler);\n      };\n    }\n  }, [hasConnectedAccount, postMessage, origin]);\n\n  // Disconnect if the user switches to a different wallet.\n  useEffect(() => {\n    if (\n      !isExtension &&\n      wallet &&\n      connectedAccount &&\n      !connectedAccount.equals(wallet.publicKey)\n    ) {\n      setConnectedAccount(null);\n    }\n  }, [connectedAccount, wallet]);\n\n  // Push requests from the parent window into a queue.\n  useEffect(() => {\n    function messageHandler(e) {\n      if (e.origin === origin && e.source === window.opener) {\n        if (!AUTHORIZED_METHODS.includes(e.data.method)) {\n          postMessage({ error: 'Unsupported method', id: e.data.id });\n        }\n\n        setRequests((requests) => [...requests, e.data]);\n      }\n    }\n    window.addEventListener('message', messageHandler);\n    return () => window.removeEventListener('message', messageHandler);\n  }, [origin, postMessage]);\n\n  const request = requests[0];\n  const popRequest = () => setRequests((requests) => requests.slice(1));\n\n  const { messages, messageDisplay } = useMemo(() => {\n    if (!request || request.method === 'connect') {\n      return { messages: [], messageDisplay: 'tx' };\n    }\n    switch (request.method) {\n      case 'diffieHellman':\n        return {\n          messages: [request.params.publicKey],\n          messageDisplay: 'diffieHellman',\n        };\n      case 'signTransaction':\n        return {\n          messages: [bs58.decode(request.params.message)],\n          messageDisplay: 'tx',\n        };\n      case 'signAllTransactions':\n        return {\n          messages: request.params.messages.map((m) => bs58.decode(m)),\n          messageDisplay: 'tx',\n        };\n      case 'sign':\n        if (!(request.params.data instanceof Uint8Array)) {\n          throw new Error('Data must be an instance of Uint8Array');\n        }\n        return {\n          messages: [request.params.data],\n          messageDisplay: request.params.display === 'utf8' ? 'utf8' : 'hex',\n        };\n      default:\n        throw new Error('Unexpected method: ' + request.method);\n    }\n  }, [request]);\n\n  if (hasConnectedAccount && requests.length === 0) {\n    if (isExtension) {\n      window.close();\n    } else {\n      focusParent();\n    }\n\n    return (\n      <Typography>\n        {isExtension\n          ? 'Submitting...'\n          : 'Please keep this window open in the background.'}\n      </Typography>\n    );\n  }\n\n  if (!wallet) {\n    return <Typography>Loading wallet...</Typography>;\n  }\n\n  const mustConnect =\n    !connectedAccount || !connectedAccount.equals(wallet.publicKey);\n  // We must detect when to show the connection form on the website as it is not sent as a request.\n  if (\n    (isExtension && request.method === 'connect') ||\n    (!isExtension && mustConnect)\n  ) {\n    // Approve the parent page to connect to this wallet.\n    function connect(autoApprove) {\n      setConnectedAccount(wallet.publicKey);\n      if (isExtension) {\n        chrome.storage.local.get('connectedWallets', (result) => {\n          // TODO better way to do this\n          const account = accounts.find((account) =>\n            account.address.equals(wallet.publicKey),\n          );\n          const connectedWallets = {\n            ...(result.connectedWallets || {}),\n            [origin]: {\n              publicKey: wallet.publicKey.toBase58(),\n              selector: account.selector,\n              autoApprove,\n            },\n          };\n          chrome.storage.local.set({ connectedWallets });\n        });\n      }\n      postMessage({\n        method: 'connected',\n        params: { publicKey: wallet.publicKey.toBase58(), autoApprove },\n        id: isExtension ? request.id : undefined,\n      });\n      setAutoApprove(autoApprove);\n      if (!isExtension) {\n        focusParent();\n      } else {\n        popRequest();\n      }\n    }\n\n    return <ApproveConnectionForm origin={origin} onApprove={connect} />;\n  }\n\n  assert(AUTHORIZED_METHODS.includes(request.method) && wallet);\n\n  async function onApprove() {\n    popRequest();\n    switch (request.method) {\n      case 'diffieHellman':\n        return diffieHellman(messages[0]);\n      case 'signTransaction':\n      case 'sign':\n        sendSignature(messages[0]);\n        break;\n      case 'signAllTransactions':\n        sendAllSignatures(messages);\n        break;\n      default:\n        throw new Error('Unexpected method: ' + request.method);\n    }\n  }\n\n  async function sendSignature(message) {\n    postMessage({\n      result: {\n        signature: await wallet.createSignature(message),\n        publicKey: wallet.publicKey.toBase58(),\n      },\n      id: request.id,\n    });\n  }\n\n  async function sendAllSignatures(messages) {\n    let signatures;\n    // Ledger must sign one by one.\n    if (wallet.type === 'ledger') {\n      signatures = [];\n      for (let k = 0; k < messages.length; k += 1) {\n        signatures.push(await wallet.createSignature(messages[k]));\n      }\n    } else {\n      signatures = await Promise.all(\n        messages.map((m) => wallet.createSignature(m)),\n      );\n    }\n    postMessage({\n      result: {\n        signatures,\n        publicKey: wallet.publicKey.toBase58(),\n      },\n      id: request.id,\n    });\n  }\n\n  function diffieHellman(publicKey) {\n    const keys = generateDiffieHelllman(\n      publicKey,\n      wallet.provider.account.secretKey,\n    );\n    postMessage({\n      result: keys,\n      id: request.id,\n    });\n  }\n\n  function sendReject() {\n    popRequest();\n    postMessage({\n      error: 'Transaction cancelled',\n      id: request.id,\n    });\n  }\n\n  return (\n    <ApproveSignatureForm\n      key={request.id}\n      autoApprove={autoApprove}\n      origin={origin}\n      messages={messages}\n      messageDisplay={messageDisplay}\n      onApprove={onApprove}\n      onReject={sendReject}\n    />\n  );\n}\n\n/**\n * Switch focus to the parent window. This requires that the parent runs\n * `window.name = 'parent'` before opening the popup.\n */\nfunction focusParent() {\n  try {\n    window.open('', 'parent');\n  } catch (err) {\n    console.log('err', err);\n  }\n}\n\nconst useStyles = makeStyles((theme) => ({\n  connection: {\n    marginTop: theme.spacing(3),\n    marginBottom: theme.spacing(3),\n    textAlign: 'center',\n  },\n  transaction: {\n    wordBreak: 'break-all',\n  },\n  approveButton: {\n    backgroundColor: '#43a047',\n    color: 'white',\n  },\n  actions: {\n    justifyContent: 'space-between',\n  },\n  snackbarRoot: {\n    backgroundColor: theme.palette.background.paper,\n  },\n  warningMessage: {\n    margin: theme.spacing(1),\n    color: theme.palette.text.primary,\n  },\n  warningIcon: {\n    marginRight: theme.spacing(1),\n    fontSize: 24,\n  },\n  warningTitle: {\n    color: theme.palette.warning.light,\n    fontWeight: 600,\n    fontSize: 16,\n    alignItems: 'center',\n    display: 'flex',\n  },\n  warningContainer: {\n    marginTop: theme.spacing(1),\n  },\n  divider: {\n    marginTop: theme.spacing(2),\n    marginBottom: theme.spacing(2),\n  },\n}));\n\nfunction ApproveConnectionForm({ origin, onApprove }) {\n  const wallet = useWallet();\n  const { accounts, hardwareWalletAccount } = useWalletSelector();\n  // TODO better way to do this\n  const account = accounts\n    .concat([hardwareWalletAccount])\n    .find((account) => account && account.address.equals(wallet.publicKey));\n  const classes = useStyles();\n  const [autoApprove, setAutoApprove] = useState(false);\n  let [dismissed, setDismissed] = useLocalStorageState(\n    'dismissedAutoApproveWarning',\n    false,\n  );\n  return (\n    <Card>\n      <CardContent>\n        <Typography variant=\"h6\" component=\"h1\" gutterBottom>\n          Allow this site to access your Solana account?\n        </Typography>\n        <div className={classes.connection}>\n          <Typography>{origin}</Typography>\n          <ImportExportIcon fontSize=\"large\" />\n          <Typography>{account.name}</Typography>\n          <Typography variant=\"caption\">\n            ({wallet.publicKey.toBase58()})\n          </Typography>\n        </div>\n        <Typography>Only connect with sites you trust.</Typography>\n        <Divider className={classes.divider} />\n        <FormControlLabel\n          control={\n            <Switch\n              checked={autoApprove}\n              onChange={() => setAutoApprove(!autoApprove)}\n              color=\"primary\"\n            />\n          }\n          label={`Automatically approve transactions from ${origin}`}\n        />\n        {!dismissed && autoApprove && (\n          <SnackbarContent\n            className={classes.warningContainer}\n            message={\n              <div>\n                <span className={classes.warningTitle}>\n                  <WarningIcon className={classes.warningIcon} />\n                  Use at your own risk.\n                </span>\n                <Typography className={classes.warningMessage}>\n                  This setting allows sending some transactions on your behalf\n                  without requesting your permission for the remainder of this\n                  session.\n                </Typography>\n              </div>\n            }\n            action={[\n              <Button onClick={() => setDismissed('1')}>I understand</Button>,\n            ]}\n            classes={{ root: classes.snackbarRoot }}\n          />\n        )}\n      </CardContent>\n      <CardActions className={classes.actions}>\n        <Button onClick={window.close}>Cancel</Button>\n        <Button\n          color=\"primary\"\n          onClick={() => onApprove(autoApprove)}\n          disabled={!dismissed && autoApprove}\n        >\n          Connect\n        </Button>\n      </CardActions>\n    </Card>\n  );\n}\n\nfunction ApproveSignatureForm({\n  origin,\n  messages,\n  messageDisplay,\n  onApprove,\n  onReject,\n  autoApprove,\n}) {\n  const classes = useStyles();\n  const buttonRef = useRef();\n\n  const isMultiTx = messageDisplay === 'tx' && messages.length > 1;\n\n  const renderFormContent = () => {\n    if (messageDisplay === 'tx') {\n      return (\n        <SignTransactionFormContent\n          autoApprove={autoApprove}\n          origin={origin}\n          messages={messages}\n          onApprove={onApprove}\n          buttonRef={buttonRef}\n        />\n      );\n    } else {\n      return (\n        <SignFormContent\n          origin={origin}\n          message={messages[0]}\n          messageDisplay={messageDisplay}\n          buttonRef={buttonRef}\n        />\n      );\n    }\n  };\n\n  return (\n    <Card>\n      {renderFormContent()}\n      <CardActions className={classes.actions}>\n        <Button onClick={onReject}>Cancel</Button>\n        <Button\n          ref={buttonRef}\n          className={classes.approveButton}\n          variant=\"contained\"\n          color=\"primary\"\n          onClick={onApprove}\n        >\n          Approve{isMultiTx ? ' All' : ''}\n        </Button>\n      </CardActions>\n    </Card>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}